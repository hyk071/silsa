<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>카카오맵 주소 -> 위도/경도 검색 샘플 (수정본)</title>
  <!--
    수정 목적: "Uncaught ReferenceError: kakao is not defined" 오류 수정
    - 원인: 페이지가 카카오 SDK를 사용하기 전에 kakao 객체에 접근해서 발생.
    - 해결 방법:
      1) 메인 초기화 함수(initMap)를 미리 정의한 후 SDK <script>에 onload="initMap()" 를 사용하여
         SDK가 완전히 로드된 시점에 초기화가 수행되도록 변경.
      2) 프로토콜 상대 경로(//...) 대신 https:// 명시 사용 (로컬 파일에서의 로드 안정성 향상).
      3) SDK 로드 실패를 처리하는 onerror 핸들러 추가.
    추가 변경:
    - 샘플 주소(테스트 케이스)를 몇 가지 추가하여 빠르게 동작 확인 가능하게 함.
    - 초기화 중 발생하는 예외를 잡아 UI에 상태 표시.

    사용법:
    1) 이 파일을 index.html로 저장합니다.
    2) 브라우저로 엽니다. (로컬 file://로 열어도 동작함을 목표로 했습니다.)
    3) 주소를 입력하고 검색 버튼을 누르거나 Enter 키를 눌러 결과 확인.
  -->

  <style>
    body { font-family: Arial, "Noto Sans KR", sans-serif; margin: 0; padding: 16px; background:#f7f7f7 }
    .container{ max-width:980px; margin:0 auto; background:white; padding:18px; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    h1{ margin:0 0 12px 0; font-size:20px }
    label{ display:block; margin-bottom:6px }
    input[type=text]{ width:60%; padding:8px; font-size:14px }
    button{ padding:8px 12px; font-size:14px; margin-left:8px }
    #map{ width:100%; height:380px; margin-top:12px; border-radius:6px }
    .result{ margin-top:12px; padding:10px; background:#fafafa; border-radius:6px }
    .row{ display:flex; gap:8px; align-items:center }
    .badge{ background:#eee; padding:6px 10px; border-radius:6px; font-family:monospace }
    .muted{ color:#666; font-size:13px }
    .small{ font-size:13px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>카카오맵 주소 검색 → 위도/경도 반환 (수정본)</h1>
    <p class="muted">오류 수정: SDK가 준비된 이후에만 kakao 객체를 사용하도록 변경했습니다. 데이터 분석가 관점으로 간단, 명확하게 동작합니다.</p>

    <div style="margin-top:12px">
      <label for="query">주소 검색</label>
      <div class="row">
        <input id="query" type="text" placeholder="예: 서울특별시 중구 세종대로 110" />
        <button id="searchBtn">검색</button>
        <button id="sampleBtn">샘플 주소 넣기</button>
        <select id="sampleSelect" class="small">
          <option value="">빠른 테스트 주소 선택</option>
          <option value="서울특별시 중구 세종대로 110 (시청)">서울시청</option>
          <option value="서울특별시 강남구 강남대로 396 (역삼동)">강남역 근처</option>
          <option value="부산광역시 연제구 거제대로 362">부산 연제구</option>
        </select>
        <button id="fillSampleBtn" class="small">선택 채우기</button>
      </div>
    </div>

    <div id="map"></div>

    <div class="result" id="result">
      <div><strong>검색 결과</strong></div>
      <div style="margin-top:8px">상태: <span id="status">대기 중</span></div>
      <div style="margin-top:8px">주소(응답): <span id="addr">-</span></div>
      <div style="margin-top:8px">위도(Lat): <span class="badge" id="lat">-</span>  경도(Lng): <span class="badge" id="lng">-</span></div>
      <div style="margin-top:8px"><button id="copyBtn">좌표 복사</button> <span class="muted">(클립보드에 'lat, lng' 형태로 복사됩니다)</span></div>
    </div>

    <hr style="margin:18px 0" />
    <div class="muted">주의 및 팁:</div>
    <ul>
      <li class="muted">이 예제는 개발/테스트용입니다. 배포 시에는 카카오 개발자 콘솔에서 자바스크립트 키의 도메인 제한을 설정하세요.</li>
      <li class="muted">로컬에서 테스트 시 브라우저 보안 정책으로 외부 스크립트 로드가 제한될 수 있습니다. 그런 경우 간단한 로컬 서버(e.g., Python의 <code>python -m http.server</code>)로 실행해 보세요.</li>
    </ul>
  </div>

  <!--
    메인 스크립트(먼저 정의): initMap 함수를 정의한 후 SDK 스크립트의 onload에서 호출합니다.
    이렇게 하면 kakao가 정의되지 않아 발생하는 오류를 방지할 수 있습니다.
  -->
  <script>
    // UI 업데이트 헬퍼 (SDK가 없어도 사용할 수 있음)
    function updateResult(statusText, addressText, lat, lng) {
      document.getElementById('status').textContent = statusText || '-';
      document.getElementById('addr').textContent = addressText || '-';
      document.getElementById('lat').textContent = (lat !== undefined && lat !== null) ? Number(lat).toFixed(6) : '-';
      document.getElementById('lng').textContent = (lng !== undefined && lng !== null) ? Number(lng).toFixed(6) : '-';
    }

    // SDK 로드 실패 시 호출되는 함수
    function sdkLoadError() {
      console.error('카카오 맵 SDK 로드 실패');
      updateResult('카카오 SDK 로드 실패(네트워크 또는 키 문제)', null);
      // 사용자에게 추가 안내 필요시 alert로 보여줄 수 있음
      // alert('카카오 맵 SDK 로드에 실패했습니다. 네트워크를 확인하거나 키를 검토하세요.');
    }

    // 이 함수는 "카카오 SDK가 완전히 로드된 시점"에 호출됩니다.
    function initMap() {
      try {
        if (!window.kakao || !kakao.maps) {
          // SDK가 로드되었어도 kakao.maps가 준비되지 않았을 가능성에 대한 체크
          console.error('kakao 또는 kakao.maps가 정의되어 있지 않습니다.');
          updateResult('카카오 SDK가 준비되지 않았습니다.', null);
          return;
        }

        // 지도 및 서비스 초기화
        const mapContainer = document.getElementById('map');
        const mapOption = {
          center: new kakao.maps.LatLng(37.5665, 126.9780), // 서울 시청 근처
          level: 5
        };
        const map = new kakao.maps.Map(mapContainer, mapOption);

        // 재사용 가능한 마커 객체 하나만 생성
        const marker = new kakao.maps.Marker({ position: map.getCenter(), map: map });

        // 주소 -> 좌표 변환기
        const geocoder = new kakao.maps.services.Geocoder();

        // 주소 검색 실행
        function doSearchAddress(query) {
          if (!query || !query.trim()) {
            updateResult('주소를 입력하세요.', null);
            return;
          }

          updateResult('검색 중...', null);

          geocoder.addressSearch(query, function(results, status) {
            if (status === kakao.maps.services.Status.OK) {
              const res = results[0];
              const lat = parseFloat(res.y);
              const lng = parseFloat(res.x);

              const coord = new kakao.maps.LatLng(lat, lng);
              map.setCenter(coord);
              marker.setPosition(coord);

              // road_address가 있는 경우 우선 표시
              const addressDisplay = (res.road_address && res.road_address.address_name) || res.address_name || '-';
              updateResult('성공', addressDisplay, lat, lng);
            } else if (status === kakao.maps.services.Status.ZERO_RESULT) {
              updateResult('검색 결과가 없습니다.', null);
            } else if (status === kakao.maps.services.Status.ERROR) {
              updateResult('서버 에러가 발생했습니다. 잠시 후 시도하세요.', null);
            } else {
              updateResult('알 수 없는 상태: ' + status, null);
            }
          });
        }

        // 이벤트 바인딩 (초기화 이후에만 바인딩)
        document.getElementById('searchBtn').addEventListener('click', function() {
          const q = document.getElementById('query').value;
          doSearchAddress(q);
        });

        document.getElementById('query').addEventListener('keydown', function(e) {
          if (e.key === 'Enter') {
            doSearchAddress(this.value);
          }
        });

        document.getElementById('sampleBtn').addEventListener('click', function() {
          document.getElementById('query').value = '서울특별시 중구 세종대로 110 (시청)';
        });

        document.getElementById('fillSampleBtn').addEventListener('click', function() {
          const sel = document.getElementById('sampleSelect');
          if (sel && sel.value) document.getElementById('query').value = sel.value;
        });

        document.getElementById('copyBtn').addEventListener('click', function() {
          const lat = document.getElementById('lat').textContent;
          const lng = document.getElementById('lng').textContent;
          if (lat === '-' || lng === '-') {
            alert('복사할 좌표가 없습니다. 먼저 주소를 검색하세요.');
            return;
          }
          const text = lat + ', ' + lng;
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(function() {
              alert('좌표가 복사되었습니다: ' + text);
            }).catch(function(err) {
              alert('클립보드 복사 실패: ' + err);
            });
          } else {
            // 레거시 브라우저용 폴백
            const ta = document.createElement('textarea');
            ta.value = text;
            document.body.appendChild(ta);
            ta.select();
            try {
              document.execCommand('copy');
              alert('좌표가 복사되었습니다: ' + text);
            } catch (e) {
              alert('복사 실패: ' + e);
            }
            document.body.removeChild(ta);
          }
        });

        // 초기 상태
        updateResult('대기 중', null);

      } catch (err) {
        console.error('initMap 예외:', err);
        updateResult('초기화 중 오류: ' + (err && err.message ? err.message : err), null);
      }
    }
  </script>

  <!--
    SDK는 이 스크립트 태그가 로드된 뒤 onload로 initMap을 호출합니다.
    - https 명시: 로컬 파일에서 // 로 시작하는 프로토콜 상대 URL이 문제를 일으킬 수 있으므로 https:// 사용.
    - onerror 핸들러로 실패 표시 처리.
  -->
  <script type="text/javascript">
      import { KAKAO_MAPS_APP_KEY } from './src/config.js';
      kakao.maps.load(KAKAO_MAPS_APP_KEY);
  </script>

</body>
</html>
